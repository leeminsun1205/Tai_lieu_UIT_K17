CREATE TABLE GIANGVIEN(
	MAGV CHAR(5),
	HOTEN NVARCHAR(20),
	EMAIL VARCHAR(20),
	CONSTRAINT PK_GIANGVIEN PRIMARY KEY (MAGV)
)
DELETE FROM GIANGVIEN
CREATE TABLE MONTHI(
	MAMON CHAR(5),
	TENMON NVARCHAR(20),
	NGAYTHI DATETIME,
	PHONGTHI CHAR(5),
	MAGV CHAR(5),
	CONSTRAINT PK_MONTHI PRIMARY KEY (MAMON),
	CONSTRAINT FK_MONTHI FOREIGN KEY (MAGV) REFERENCES GIANGVIEN(MAGV)
)
CREATE TABLE SINHVIEN(
	MASV CHAR(8),
	HOTEN NVARCHAR(20),
	NGSINH DATETIME,
	GIOITINH NVARCHAR(3),
	CONSTRAINT PK_SINHVIEN PRIMARY KEY (MASV)
)
CREATE TABLE DIEM(
	MASV CHAR(8),
	MAMON CHAR(5),
	DIEM FLOAT,
	CONSTRAINT PK_DIEM PRIMARY KEY (MASV, MAMON),
	FOREIGN KEY (MASV) REFERENCES SINHVIEN(MASV),
	FOREIGN KEY (MAMON) REFERENCES MONTHI(MAMON)
)

INSERT INTO GIANGVIEN VALUES ('80001', N'Phạm Văn Vinh', 'vinhpv@mail.com')
INSERT INTO GIANGVIEN VALUES ('80002', N'Hoàng Xuân An', 'anxh@mail.com')
INSERT INTO GIANGVIEN VALUES ('80003', N'Nguyễn Tiến Thịnh', 'thinhnt@mail.com')
INSERT INTO GIANGVIEN VALUES ('80004', N'Đỗ Đình Quang', 'quangdd@mail.com')
INSERT INTO GIANGVIEN VALUES ('80005', N'Nguyễn Tấn Hùng', 'hungnt@mail.com')
INSERT INTO GIANGVIEN VALUES ('80006', N'Lê Văn Độ', 'dolv@mail.com')

INSERT INTO MONTHI VALUES ('IT001', N'Nhập môn lập trình', '2022/12/29', 'B1.02', '80001')
INSERT INTO MONTHI VALUES ('IT002', N'Hướng đối tượng', '2022/12/30', 'B1.04', '80002')
INSERT INTO MONTHI VALUES ('IT003', N'Cấu trúc dữ liệu', '2023/01/02', 'B1.06', '80003')
INSERT INTO MONTHI VALUES ('ENG01', N'Anh văn 1', '2023/01/03', 'B1.08', '80004')
INSERT INTO MONTHI VALUES ('ENG02', N'Anh văn 2', '2023/01/04', 'B1.02', '80005')
INSERT INTO MONTHI VALUES ('MA001', N'Toán cao cấp', '2023/01/05', 'B1.04', '80006')

INSERT INTO SINHVIEN VALUES ('09521001', N'Đinh Bá Tiên', '2000/02/11', 'Nam')
INSERT INTO SINHVIEN VALUES ('09521002', N'Nguyễn Thanh Tùng', '2000/08/20', 'Nam')
INSERT INTO SINHVIEN VALUES ('09521003', N'Bùi Ngọc Hằng', '1999/03/11', N'Nữ')
INSERT INTO SINHVIEN VALUES ('09521004', N'Lê Quỳnh Như', '2000/02/01', N'Nữ')
INSERT INTO SINHVIEN VALUES ('09521005', N'Nguyễn Mạnh Hùng', '2000/05/04', 'Nam')
INSERT INTO SINHVIEN VALUES ('09521006', N'Trần Thanh Tâm', '2000/10/19', 'Nam')
INSERT INTO SINHVIEN VALUES ('09521007', N'Trần Hồng Quang', '2000/12/21', 'Nam')

INSERT INTO DIEM VALUES ('09521001', 'IT001', 7)
INSERT INTO DIEM VALUES ('09521002', 'IT001', 8)
INSERT INTO DIEM VALUES ('09521003', 'IT001', 9)
INSERT INTO DIEM VALUES ('09521004', 'IT001', 9)
INSERT INTO DIEM VALUES ('09521005', 'IT001', 8)
INSERT INTO DIEM VALUES ('09521006', 'IT001', 9)
INSERT INTO DIEM VALUES ('09521007', 'IT001', 10)
INSERT INTO DIEM VALUES ('09521003', 'IT002', 6)
INSERT INTO DIEM VALUES ('09521004', 'IT002', 7)
INSERT INTO DIEM VALUES ('09521005', 'IT002', 9)
INSERT INTO DIEM VALUES ('09521006', 'IT002', 8)
INSERT INTO DIEM VALUES ('09521004', 'IT003', 10)
INSERT INTO DIEM VALUES ('09521005', 'IT003', 9)
INSERT INTO DIEM VALUES ('09521006', 'IT003', 8)
INSERT INTO DIEM VALUES ('09521007', 'IT003', 10)
INSERT INTO DIEM VALUES ('09521001', 'ENG01', 5)
INSERT INTO DIEM VALUES ('09521002', 'ENG01', 6)
INSERT INTO DIEM VALUES ('09521003', 'ENG01', 8)
INSERT INTO DIEM VALUES ('09521004', 'ENG01', 7)
INSERT INTO DIEM VALUES ('09521005', 'ENG02', 8)
INSERT INTO DIEM VALUES ('09521006', 'ENG02', 6)
INSERT INTO DIEM VALUES ('09521007', 'ENG02', 7)
INSERT INTO DIEM VALUES ('09521001', 'MA001', 6)
INSERT INTO DIEM VALUES ('09521002', 'MA001', 7)
INSERT INTO DIEM VALUES ('09521003', 'MA001', 6)
INSERT INTO DIEM VALUES ('09521004', 'MA001', 7)
INSERT INTO DIEM VALUES ('09521005', 'MA001', 8)
INSERT INTO DIEM VALUES ('09521006', 'MA001', 7)
INSERT INTO DIEM VALUES ('09521007', 'MA001', 8)

CREATE TRIGGER unique_exam_per_teacher
BEFORE INSERT ON MonThi
FOR EACH ROW
BEGIN
    DECLARE count_exams INT;
    SELECT COUNT(*) INTO count_exams FROM MonThi WHERE magv = NEW.magv;
    IF count_exams >= 1 THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Mỗi giảng viên chỉ được ra đề duy nhất cho một môn thi!';
    END IF;
END //
